trigger:
  branches:
    include:
      - release/*
      - hotfix/*

pr:
  branches:
    include:
      - release/*
      - hotfix/*

stages:
  - stage: ValidateBranch
    displayName: "Validate Branch"
    jobs:
      - job: CheckBranch
        displayName: "Check Branch Compatibility"
        steps:
          - script: |
              echo "Validating branch..."
              if [[ ! $(Build.SourceBranch) =~ ^refs/heads/(release|hotfix)/ ]]; then
                echo "Error: Pipeline can only run on 'release/*' or 'hotfix/*' branches."
                exit 1
              fi
            displayName: "Validate if branch is allowed"

  - stage: InstallTerraform
    displayName: "Install Terraform"
    jobs:
      - job: TerraformInstall
        displayName: "Install Terraform"
        steps:
          - script: |
              echo "Installing Terraform..."
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
              curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              sudo apt update && sudo apt install terraform
              terraform --version
            displayName: "Install Terraform"

  - stage: Deploy
    displayName: "Terraform Deployment"
    dependsOn: [ValidateBranch, InstallTerraform]
    condition: succeeded()
    jobs:
      - job: TerraformDeploy
        displayName: "Deploy Resource Group"
        steps:
          - script: |
              terraform init
              terraform apply -auto-approve
            displayName: "Initialize and Apply Terraform"
